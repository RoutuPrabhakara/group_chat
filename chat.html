<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Chat</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
        <!-- <h1>Chat Screen</h1> -->
       
        <audio src="./assets/media/sent_sound.mp3" id="sound"></audio>
        <header>
            <div>
                <h4 id="email"></h4>
                <p>Welcome to Group Chat</p>
            </div>

            <button class="logout" onclick="logoutHanlder()" title="click to logout">Logout</button>
        </header>
    
    <hr>
<div class="message">
    
    <input type="text" placeholder="type here.." id="message" onkeypress="sendEnter(event)">
    <button onclick="messageSendhanlder()">send</button>
</div>
    <ul id="chat"></ul>

    <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBieLWRvpgHFtYDSC4JZAxGpX6TybvBY_I",
            authDomain: "chat-application-5f972.firebaseapp.com",
            projectId: "chat-application-5f972",
            storageBucket: "chat-application-5f972.firebasestorage.app",
            messagingSenderId: "733620020619",
            appId: "1:733620020619:web:a77e30a657a5a9386bfb8e",
            measurementId: "G-SBR0Q3159T"
        };
        const app = firebase.initializeApp(firebaseConfig);//we are intializing firebase confirgurations in app
        // const authenticationRoom = firebase.auth(); //importing authentication room from firebase to create users
        const databaseRoom = firebase.database(); //we are importing database room to store messages in database

  
        

        //creating messages folder in database folder in firebase
        const messageFolder = databaseRoom.ref('messages'); //messages is the database folder name




        // localStorage.setItem('test', 'hello this is the text');
        const h4TagEmail = document.getElementById('email')
        var user = localStorage.getItem('user'); //we are getting thed data from local storage with key name is user and storing in user variable
        console.log(user);

        if(user==null){//if user is not present in local storage that will be null that time send that user to login page
            //in html we can visit from page to onother one page using anchor tag inn javascript we can use window.location.href=destination link

            window.location.href='./index.html'
        }else{
            h4TagEmail.innerText = 'Hello ðŸ‘‹ ' + user
        }


        function logoutHanlder(){
          if(confirm('Do you want to logout?')){
            //if user clicks ok button this will be execute
            localStorage.removeItem('user');
            window.location.reload(); //to refresh the page
          }else{
            //if user clicks cancel button this will be  execute

          }

        // window.location.reload()
        }

       

  



        //message send code
     

        function messageSendhanlder(){
            let messageInput = document.getElementById('message');//getting message input
            // console.log(messageInput.value);
            if(messageInput.value ==''){
                alert('please enter the message')
            }else{
                let newMessage = {
                    message:messageInput.value,
                    time:Date.now(),
                    userEmail:localStorage.getItem('user')
                }
                console.log(newMessage);
                messageFolder.push(newMessage);
                messageInput.value = '';
                // let audio = new Audio('./assets/media/sent_sound.mp3');
                // audio.play();
                chatScreen.scrollTop = chatScreen.scrollHeight;
            }
                
                // messageFolder.push()
        }



        //to display the message

        let chatScreen = document.getElementById('chat');
        let sound = document.getElementById('sound');
     
        chatScreen.innerHTML = '<li><h1>Loading...</h1></li>'
        function MessageLoader(){
            chatScreen.scrollTop = chatScreen.scrollHeight;
            messageFolder.on('value', (data)=>{
            //we are checking if value is there or not in messagesFOlder if it is tehre we are runnig one callbackfunction that bis arrow function
            console.log(data);
            chatScreen.innerHTML = '';
            data.forEach((msg)=>{
                console.log(msg.val());

                const {message, userEmail, time} = msg.val();
                console.log(message);
                console.log(userEmail);
                console.log(time);
              
                if(userEmail == localStorage.getItem('user')){
                      chatScreen.innerHTML += `
                  <li class='my_message'>
                    
                        <div>${message}</div>
                         <img src="https://static.vecteezy.com/system/resources/thumbnails/003/337/584/small/default-avatar-photo-placeholder-profile-icon-vector.jpg" alt="loading.."> 
                    </li>`
                }else{
                      chatScreen.innerHTML += `
                     <li class='friend_message'>
                        <img src="https://static.vecteezy.com/system/resources/thumbnails/003/337/584/small/default-avatar-photo-placeholder-profile-icon-vector.jpg" alt="loading.."> 
                        <div>${message}</div>
                         </li>`
                }
            })
            

        })
        }
        // <b>User:</b> ${userEmail}<br>
        //             <b>date:</b> ${new Date(time).toLocaleDateString()} <br>
        //             <b>Time:</b> ${new Date(time).toLocaleTimeString()}<br>

        MessageLoader();

        console.log('height=', chatScreen.offsetHeight);
        chatScreen.scrollTop = chatScreen.scrollHeight;
        


        messageFolder.on('child_added', async ()=>{
            console.log('added');
            // let audio = new Audio('./assets/media/sent_sound.mp3');
            // audio.play();

            sound.play().catch(error => {
            console.error('Error playing audio:', error);
            chatScreen.scrollTop = chatScreen.scrollHeight;
    });
            
        })



        //send message when user eneters the enter button
        function sendEnter(e){
            if(e.key === 'Enter'){
                messageSendhanlder()
            }
        }
    </script>
    
</body>
</html>