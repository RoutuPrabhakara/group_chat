<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Chat</title>
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="./media.css">
</head>
<body>
        <!-- <h1>Chat Screen</h1> -->
       
        <audio src="./assets/media/sent_sound.mp3" id="sound"></audio>
        <!-- <header>
            <div>
                <h4 id="email"></h4>
                <p>Welcome to Group Chat</p>
            </div>

            <button class="logout" onclick="logoutHanlder()" title="click to logout">Logout</button>
        </header> -->
    
    <!-- <hr> -->
<!-- <div class="message">
    
   
</div> -->
    
     <div class="container">
        <div class="left">

        </div>
        <div class="middle"></div>

        <div class="right">
            <div class="top">

            </div>
            <div class="messages">
                <ul id="chat"></ul>
            </div>
            <div class="builtin-messages">
                <!-- Quick Messages -->
                <button class="button">Hello!</button>
                <button class="button">How are you?</button>
                <button class="button">Good morning!</button>
                <button class="button">Good afternoon!</button>
                <button class="button">Good evening!</button>
                <button class="button">Nice to meet you!</button>
                <button class="button">Howâ€™s your day going?</button>
                <button class="button">Whatâ€™s up?</button>
                <button class="button">Long time no see!</button>
                <button class="button">Howâ€™s everything?</button>
                
                <!-- Polite Expressions -->
                <button class="button">Thank you!</button>
                <button class="button">Youâ€™re welcome.</button>
                <button class="button">I appreciate it.</button>
                <button class="button">Please.</button>
                <button class="button">Sorry about that.</button>
                <button class="button">Excuse me.</button>
                <button class="button">No problem!</button>
                <button class="button">Iâ€™ll get back to you.</button>
                <button class="button">It was a pleasure.</button>
                <button class="button">Can I help you?</button>
                
                <!-- Small Talk -->
                <button class="button">Howâ€™s the weather?</button>
                <button class="button">Whatâ€™s your favorite hobby?</button>
                <button class="button">Do you have any plans for the weekend?</button>
                <button class="button">What are you working on?</button>
                <button class="button">Did you see the game last night?</button>
                <button class="button">Have you seen any good movies lately?</button>
                <button class="button">Do you like music?</button>
                <button class="button">Howâ€™s your family?</button>
                <button class="button">Where are you from?</button>
                <button class="button">Whatâ€™s your favorite food?</button>
                
                <!-- Work/Professional -->
                <button class="button">Letâ€™s schedule a meeting.</button>
                <button class="button">Can you send me the file?</button>
                <button class="button">Do you need help?</button>
                <button class="button">Letâ€™s discuss the project.</button>
                <button class="button">Whatâ€™s the deadline?</button>
                <button class="button">Could you review this?</button>
                <button class="button">Iâ€™ll send an update soon.</button>
                <button class="button">Let me know if you need assistance.</button>
                <button class="button">Thank you for your feedback!</button>
                <button class="button">Can we extend the deadline?</button>
              
                <!-- Casual Questions -->
                <button class="button">Howâ€™s your weekend?</button>
                <button class="button">Whatâ€™s your favorite TV show?</button>
                <button class="button">Do you like traveling?</button>
                <button class="button">Whatâ€™s your favorite destination?</button>
                <button class="button">Howâ€™s your pet?</button>
                <button class="button">Do you enjoy reading books?</button>
                <button class="button">Have you tried any new recipes lately?</button>
                <button class="button">Whatâ€™s your favorite holiday?</button>
                <button class="button">Do you play video games?</button>
                <button class="button">Whatâ€™s your favorite sport?</button>
                
                <!-- Quick Replies -->
                <button class="button">Yes</button>
                <button class="button">No</button>
                <button class="button">Maybe</button>
                <button class="button">Sure!</button>
                <button class="button">Of course!</button>
                <button class="button">I donâ€™t know.</button>
                <button class="button">Iâ€™ll think about it.</button>
                <button class="button">Sounds good!</button>
                <button class="button">Letâ€™s do it!</button>
                <button class="button">Not sure yet.</button>
              
                <!-- Other Useful Messages -->
                <button class="button">Where should we meet?</button>
                <button class="button">What time works for you?</button>
                <button class="button">Let me check my calendar.</button>
                <button class="button">Iâ€™ll be there soon.</button>
                <button class="button">Running a little late.</button>
                <button class="button">Can you send me directions?</button>
                <button class="button">Letâ€™s catch up later.</button>
                <button class="button">Itâ€™s been great talking to you!</button>
                <button class="button">Letâ€™s stay in touch.</button>
                <button class="button">Take care!</button>
              </div>
            <div class="input">
                <input type="text" placeholder="type here.." id="message" onkeypress="sendEnter(event)">
                <button  id="speech"><i class="fa-solid fa-microphone-lines"></i></button>
                <button onclick="messageSendhanlder()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
     </div>

    <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase.js"></script>
    <script>
         var messageInput = document.getElementById('message');//getting message input
        const allbtns = document.querySelectorAll('.button');
        console.log(allbtns);
        for(let i of allbtns){
            console.log(i.innerText);
            i.addEventListener('click', ()=>{
                messageInput.value += i.innerText  + " " 
                messageSendhanlder();
            })
        }
        

        const setScreenHeight = () => {
        const vh = window.innerHeight * 0.01; // 1% of the viewport height
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        };

        // Set the height on load and resize
        window.addEventListener('resize', setScreenHeight);
        window.addEventListener('load', setScreenHeight);
        const firebaseConfig = {
            apiKey: "AIzaSyBieLWRvpgHFtYDSC4JZAxGpX6TybvBY_I",
            authDomain: "chat-application-5f972.firebaseapp.com",
            projectId: "chat-application-5f972",
            storageBucket: "chat-application-5f972.firebasestorage.app",
            messagingSenderId: "733620020619",
            appId: "1:733620020619:web:a77e30a657a5a9386bfb8e",
            measurementId: "G-SBR0Q3159T"
        };
        const app = firebase.initializeApp(firebaseConfig);//we are intializing firebase confirgurations in app
        // const authenticationRoom = firebase.auth(); //importing authentication room from firebase to create users
        const databaseRoom = firebase.database(); //we are importing database room to store messages in database

  
        

        //creating messages folder in database folder in firebase
        const messageFolder = databaseRoom.ref('messages'); //messages is the database folder name




        // localStorage.setItem('test', 'hello this is the text');
        const h4TagEmail = document.getElementById('email')
        var user = localStorage.getItem('user'); //we are getting thed data from local storage with key name is user and storing in user variable
        console.log(user);

        if(user==null){//if user is not present in local storage that will be null that time send that user to login page
            //in html we can visit from page to onother one page using anchor tag inn javascript we can use window.location.href=destination link

            window.location.href='./index.html'
        }else{
            // h4TagEmail.innerText = 'Hello ðŸ‘‹ ' + user
        }


        function logoutHanlder(){
          if(confirm('Do you want to logout?')){
            //if user clicks ok button this will be execute
            localStorage.removeItem('user');
            window.location.reload(); //to refresh the page
          }else{
            //if user clicks cancel button this will be  execute

          }

        // window.location.reload()
        }

       

  



        //message send code
     

        function messageSendhanlder(){
           
            // console.log(messageInput.value);
            if(messageInput.value ==''){
                alert('please enter the message')
            }else{
                let newMessage = {
                    message:messageInput.value,
                    time:Date.now(),
                    userEmail:localStorage.getItem('user')
                }
                console.log(newMessage);
                messageFolder.push(newMessage);
                messageInput.value = '';
                // let audio = new Audio('./assets/media/sent_sound.mp3');
                // audio.play();
                chatScreen.scrollTop = chatScreen.scrollHeight;
            }
                
                // messageFolder.push()
        }



        //to display the message

        let chatScreen = document.getElementById('chat');
        let sound = document.getElementById('sound');
     
        chatScreen.innerHTML = '<li><h1>Loading...</h1></li>'
        function MessageLoader(){
            chatScreen.scrollTop = chatScreen.scrollHeight;
            messageFolder.on('value', (data)=>{
            //we are checking if value is there or not in messagesFOlder if it is tehre we are runnig one callbackfunction that bis arrow function
            console.log(data);
            chatScreen.innerHTML = '';
            data.forEach((msg)=>{
                console.log(msg.val());

                const {message, userEmail, time} = msg.val();
                console.log(message);
                console.log(userEmail);
                console.log(time);
              
                if(userEmail == localStorage.getItem('user')){
                      chatScreen.innerHTML += `
                  <li class='my_message'>
                    
                        <div class="message">${message}</div>
                         <div style="display:flex; align-items:center; gap:5px">
                         <img src="https://static.vecteezy.com/system/resources/thumbnails/003/337/584/small/default-avatar-photo-placeholder-profile-icon-vector.jpg" alt="loading.."> 
                        <div class="icon" onclick="speekMessage('${message}')"> <i class="fa-solid fa-circle-play"></i></div>
                        </div>
                    </li>`
                }else{
                      chatScreen.innerHTML += `
                     <li class='friend_message'>
                       <div style="display:flex; align-items:center; gap:5px">
                         <img src="https://static.vecteezy.com/system/resources/thumbnails/003/337/584/small/default-avatar-photo-placeholder-profile-icon-vector.jpg" alt="loading.."> 
                        <div class="icon" onclick="speekMessage('${message}')"> <i class="fa-solid fa-circle-play"></i></div>
                        </div>
                        <div class="message">${message}</div>
                         </li>`
                }
            })
            

        })
        }
        // <b>User:</b> ${userEmail}<br>
        //             <b>date:</b> ${new Date(time).toLocaleDateString()} <br>
        //             <b>Time:</b> ${new Date(time).toLocaleTimeString()}<br>

        MessageLoader();

        console.log('height=', chatScreen.offsetHeight);
        chatScreen.scrollTop = chatScreen.scrollHeight;
        


        messageFolder.on('child_added', async (data)=>{
            console.log('added');
            // let audio = new Audio('./assets/media/sent_sound.mp3');
            // audio.play();
            console.log('new message = ', data.val());
            const {message, time, userEmail} = data.val();
            // alert(data.val())
           
            if(userEmail != localStorage.getItem('user')){
                showNotification(message,  {
            body: "This is a browser notification example.", // Some text to show up on the notification
            icon: "icon.png", // Grab an icon on off the web
            })
            }

            sound.play().catch(error => {
            console.error('Error playing audio:', error);
            chatScreen.scrollTop = chatScreen.scrollHeight;
    });
            
        })



        //send message when user eneters the enter button
        function sendEnter(e){
            if(e.key === 'Enter'){
                messageSendhanlder()
            }
        }



            function showNotification(title, options) {
            if (!('Notification' in window)) {
                console.error('This browser does not support notifications.');
                return;
            }

            if (Notification.permission === 'granted') {
                new Notification(title, options);
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    new Notification("This is a title", { body: "Hello world" });
                }
                });
            }
        }


        function speekMessage(message){
            const utterance = new SpeechSynthesisUtterance(message);
            const allvoices = speechSynthesis.getVoices(); //array
            utterance.voice = allvoices[1];
            speechSynthesis.speak(utterance);
        }

        var speechBtn = document.getElementById('speech');
        // const speechBtn = document.getElementById('speech');
    const resultDisplay = document.getElementById('result');
    let recognition; // Keep recognition instance global to manage its state
    let isListening = false;

    function initializeSpeechRecognition() {
      // Create recognition instance if it doesn't exist
      if (!recognition) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false; // Stops after a single result
        recognition.lang = 'en-US'; // Set language to English
        recognition.interimResults = false; // Show only final results

        // Event: Recognition started
        recognition.onstart = () => {
          isListening = true;
 
          speechBtn.innerHTML = '<i class="fa-regular fa-circle-stop"></i>'
          console.log('Recognition started');
        };

        // Event: Recognition result
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript; // Get the recognized text
          console.log('Transcript:', transcript);
          messageInput.value = transcript;
          messageSendhanlder()
        };

        // Event: Recognition ended
        recognition.onend = () => {
          isListening = false;
          speechBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
          console.log('Recognition ended');
        };

        // Event: Error handling
        recognition.onerror = (event) => {
          isListening = false;
          speechBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
          console.error('Recognition error:', event.error);

          if (event.error === 'aborted') {
            console.log('Recognition was aborted. Restarting...');
          } else {
            alert(`An error occurred: ${event.error}`);
          }
        };
      }
    }

    function startSpeechRecognition() {
      if (isListening) {
        console.log('Recognition is already active.');
        recognition.stop()
        return; // Prevent multiple instances

      }

      // Request microphone permission
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(() => {
          initializeSpeechRecognition();
          recognition.start();
        })
        .catch((error) => {
          console.error('Microphone permission denied:', error);
          alert('Please allow microphone access to use speech recognition.');
        });
    }

    // Add event listener to the button
    speechBtn.addEventListener('click', startSpeechRecognition);
  </script>
</body>
</html>